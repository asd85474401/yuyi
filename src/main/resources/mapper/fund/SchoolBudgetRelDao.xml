<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kcidea.erms.dao.fund.SchoolBudgetRelDao">
    <select id="findBudgetListByNameYearSidPage" resultType="com.kcidea.erms.model.fund.SchoolBudgetModel">
        select sbr.id,sbg.id as budgetId,sbg.name,sbr.declare_price,sbr.total_price
        from school_budget_rel as sbr
        left join school_budget as sbg
        on sbr.budget_id = sbg.id
        where sbr.s_id = #{sid} and sbr.vyear = #{vYear}
        <if test="budgetName != null and budgetName != ''">
            and sbg.name like concat('%',#{budgetName},'%')
        </if>
    </select>
    <select id="findOneBySidId" resultType="com.kcidea.erms.domain.fund.SchoolBudgetRel">
        select *
        from school_budget_rel
        where s_id = #{sid} and id = #{id}
    </select>
    <delete id="deleteByBudgetId">
        delete from school_budget_rel
        where budget_id = #{budgetId}
    </delete>
    <select id="findOneBySidBudgetRelId" resultType="com.kcidea.erms.domain.fund.SchoolBudgetRel">
        select * from school_budget_rel where s_id = #{sid} and id = #{budgetId}
    </select>
    <select id="findBudgetListByNameYearSid" resultType="com.kcidea.erms.model.fund.SchoolBudgetExportModel">
        select sbr.id,sbg.id as budgetId,sbg.name,sbr.declare_price,sbr.total_price
        from school_budget_rel as sbr
        left join school_budget as sbg
        on sbr.budget_id = sbg.id
        where sbr.s_id = #{sid} and sbr.vyear = #{vYear}
        <if test="budgetName != null and budgetName != ''">
            and sbg.name like concat('%',#{budgetName},'%')
        </if>
    </select>
    <select id="findBudgetRankListBySidYear" resultType="com.kcidea.erms.model.fund.YearBudgetModel">
        select vyear, sum(total_price) as price
        from school_budget_rel
        where s_id = #{sid}
        group by vyear
        having vyear between #{startYear} and #{endYear}
        ORDER BY sum(total_price) desc
    </select>
</mapper>
