<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kcidea.erms.dao.ers.VdatabaseDao">

    <select id="findDidNameListBySid" resultType="com.kcidea.erms.model.common.IdNameModel">
        SELECT db.id, COALESCE(alias.d_name, db.name) name
        FROM vdatabase AS db
        LEFT JOIN school_database_alias AS alias ON alias.d_id = db.id AND alias.s_id = #{sid}
        WHERE db.custom_school_id = #{sid} or db.custom_school_id = 0
    </select>
    <select id="findDidNameListBySidDid" resultType="com.kcidea.erms.model.common.IdNameModel">
        SELECT db.id, COALESCE(alias.d_name, db.name) name
        FROM vdatabase AS db
        LEFT JOIN school_database_alias AS alias ON alias.d_id = db.id AND alias.s_id = #{sid}
        WHERE db.id = #{did}
        and (db.custom_school_id = #{sid} or db.custom_school_id = 0)
    </select>
    <select id="findOneBySidDid" resultType="com.kcidea.erms.model.database.detail.DatabaseInfoModel">
        SELECT db.id did, COALESCE(alias.d_name, db.name) name, COALESCE(alias.url, db.url) url,
               COALESCE(alias.remark, db.remark) remark
        FROM vdatabase AS db
        LEFT JOIN school_database_alias AS alias ON alias.d_id = db.id AND alias.s_id = #{sid}
        WHERE (db.custom_school_id = #{sid} or db.custom_school_id = 0) and db.id = #{did}
        LIMIT 1
    </select>
    <select id="findOneBySidName" resultType="com.kcidea.erms.domain.ers.Vdatabase">
        select id, name, code, custom_school_id, url, sort, free_flag, remark,  parent_id
        from vdatabase
        where (custom_school_id = #{sid} or custom_school_id = 0) and name = #{name}
    </select>
    <select id="findListBySidNameLetter" resultType="com.kcidea.erms.model.common.IdNameModel">
        SELECT t.id,t.name
        FROM (SELECT db.id, COALESCE(alias.d_name, db.name) name
        FROM vdatabase AS db
        LEFT JOIN school_database_alias AS alias ON alias.d_id = db.id AND alias.s_id = #{sid}
        WHERE db.custom_school_id = #{sid} or db.custom_school_id = 0
        ) t
        <where>
            <if test="name != null and name != ''">
                and name like concat('%',#{name},'%')
            </if>
            <if test="letter != null and letter != ''">
                and GET_FIRST_PINYIN_CHAR(trim(name)) = #{letter}
            </if>
        </where>
    </select>
    <select id="findIdNameListBySid" resultType="com.kcidea.erms.model.common.IdNameModel">
        select id,name from vdatabase where custom_school_id = #{sid} or custom_school_id = 0
    </select>
    <select id="findNameBySidDid" resultType="java.lang.String">
        SELECT COALESCE(alias.d_name, db.name) name
        FROM vdatabase AS db
        LEFT JOIN school_database_alias AS alias ON alias.d_id = db.id AND alias.s_id = #{sid}
        WHERE (db.custom_school_id = #{sid} or db.custom_school_id = 0) and db.id = #{did}
        LIMIT 1
    </select>

</mapper>
